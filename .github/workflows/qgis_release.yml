name: Build QGIS repo artifacts on Release

on:
  release:
    types: [published]

permissions:
  contents: write

concurrency:
  group: "qgis-release"
  cancel-in-progress: false

jobs:
  build-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Use release metadata
        run: cp metadata.release.txt metadata.txt
        shell: bash

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Determine version
        id: ver
        shell: bash
        run: |
          input_version="${{ inputs.version }}"

          if [ -n "$input_version" ]; then
            ver="$input_version"
          elif [ "${{ github.event_name }}" = "release" ]; then
            ver="${{ github.event.release.tag_name }}"
          else
            ver="${{ github.ref_name }}"
          fi

          # strip leading 'v' from tags like v2.00.3
          ver="${ver#v}"

          if [ -z "$ver" ]; then
            echo "Unable to determine version" >&2
            exit 1
          fi

          echo "version=$ver" >> "$GITHUB_OUTPUT"
          echo "Building version: $ver"

      - name: Update metadata.txt version
        shell: bash
        run: |
          python - <<'PY'
          from pathlib import Path

          version = "${{ steps.ver.outputs.version }}".strip()
          path = Path("metadata.txt")
          text = path.read_text(encoding="utf-8", errors="replace").splitlines(True)

          out = []
          replaced = False
          for line in text:
            stripped = line.strip()
            if stripped.lower().startswith("version") and ("=" in stripped or ":" in stripped):
              key, _ = (line.split("=", 1) if "=" in line else line.split(":", 1))
              if key.strip().lower() == "version":
                sep = "=" if "=" in line else ":"
                out.append(f"version{sep}{version}\n")
                replaced = True
                continue
            out.append(line)

          if not replaced:
            raise SystemExit("metadata.txt does not contain a version key")

          path.write_text("".join(out), encoding="utf-8")
          print(f"metadata.txt version set to {version}")
          PY

      - name: Build docs/qgis-repo artifacts
        shell: bash
        run: |
          python tools/qgis_repo_release.py --out docs/qgis-repo --repo-path qgis-repo

      - name: Commit and push artifacts
        shell: bash
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "Build QGIS repo artifacts v${{ steps.ver.outputs.version }}"
          git push origin HEAD:main
